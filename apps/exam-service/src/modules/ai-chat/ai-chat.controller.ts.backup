import {
    Controller,
    Get,
    Post,
    Patch,
    Delete,
    Param,
    Body,
    Req,
    UseGuards,
    Res,
    Header,
} from '@nestjs/common';
import { Response } from 'express';
import {
    ApiTags,
    ApiOperation,
    ApiResponse,
    ApiCookieAuth,
} from '@nestjs/swagger';
import { AuthGuard, AuthenticatedRequest } from '@examio/common';
import { AIChatService } from './ai-chat.service';
import { Observable } from 'rxjs';

@ApiTags('AI Chat')
@Controller('ai-chat')
@UseGuards(AuthGuard)
@ApiCookieAuth('cookie-auth')
export class AIChatController {
    constructor(private readonly chatService: AIChatService) {}

    // ==================== CHAT ====================

    @Get()
    @ApiOperation({ summary: 'Lấy danh sách chats' })
    @ApiResponse({ status: 200, description: 'Danh sách chats' })
    async getChats(@Req() req: AuthenticatedRequest) {
        return this.chatService.getChats(req.user);
    }

    @Post()
    @ApiOperation({ summary: 'Tạo chat mới' })
    @ApiResponse({ status: 201, description: 'Chat đã tạo' })
    async createChat(
        @Req() req: AuthenticatedRequest,
        @Body() body: { title?: string; subjectId?: string }
    ) {
        return this.chatService.createChat(req.user, body?.title, body?.subjectId);
    }

    @Patch(':chatId')
    @ApiOperation({ summary: 'Cập nhật chat' })
    async updateChat(
        @Req() req: AuthenticatedRequest,
        @Param('chatId') chatId: string,
        @Body() body: { title: string }
    ) {
        return this.chatService.updateChat(chatId, req.user, body.title);
    }

    @Delete(':chatId')
    @ApiOperation({ summary: 'Xóa chat' })
    async deleteChat(
        @Req() req: AuthenticatedRequest,
        @Param('chatId') chatId: string
    ) {
        return this.chatService.deleteChat(chatId, req.user);
    },

    @Post(':chatId/clear')
    @ApiOperation({ summary: 'Xóa nội dung chat và tùy chọn xóa files' })
    async clearChat(
        @Req() req: AuthenticatedRequest,
        @Param('chatId') chatId: string,
        @Body() body: { deleteFiles?: boolean }
    ) {
        return this.chatService.clearChat(chatId, req.user, body.deleteFiles || false);
    }

    @Patch('message/:messageId')
    @ApiOperation({ summary: 'Cập nhật message' })
    async updateMessage(
        @Req() req: AuthenticatedRequest,
        @Param('messageId') messageId: string,
        @Body() body: { content: string }
    ) {
        return this.chatService.updateMessage(
            messageId,
            req.user,
            body.content
        );
    }

    @Delete('message/:messageId')
    @ApiOperation({ summary: 'Xóa message' })
    async deleteMessage(
        @Req() req: AuthenticatedRequest,
        @Param('messageId') messageId: string
    ) {
        return this.chatService.deleteMessage(messageId, req.user);
    }

    @Post('message/:messageId/regenerate')
    @ApiOperation({ summary: 'Regenerate AI response từ message' })
    async regenerateFromMessage(
        @Req() req: AuthenticatedRequest,
        @Param('messageId') messageId: string
    ) {
        return this.chatService.regenerateFromMessage(messageId, req.user);
    }

    @Post('message/:messageId/regenerate-stream')
    @ApiOperation({
        summary: 'Regenerate AI response từ message với streaming (SSE)',
    })
    async regenerateFromMessageStream(
        @Req() req: AuthenticatedRequest,
        @Res() res: Response,
        @Param('messageId') messageId: string
    ) {
        res.setHeader('Content-Type', 'text/event-stream');
        res.setHeader('Cache-Control', 'no-cache');
        res.setHeader('Connection', 'keep-alive');

        const observable = await this.chatService.regenerateFromMessageStream(
            messageId,
            req.user
        );

        const subscription = observable.subscribe({
            next: (event) => {
                res.write(`data: ${JSON.stringify(event)}\n\n`);
            },
            error: (err) => {
                res.write(
                    `data: ${JSON.stringify({ type: 'error', data: err.message })}\n\n`
                );
                res.end();
            },
            complete: () => {
                res.end();
            },
        });

        req.on('close', () => {
            subscription.unsubscribe();
        });
    }

    // ==================== DOCUMENTS ====================

    @Get(':chatId/documents')
    @ApiOperation({ summary: 'Lấy documents của chat' })
    async getDocuments(
        @Req() req: AuthenticatedRequest,
        @Param('chatId') chatId: string
    ) {
        return this.chatService.getDocuments(chatId, req.user);
    }

    @Post(':chatId/documents')
    @ApiOperation({ summary: 'Thêm document vào chat' })
    async addDocument(
        @Req() req: AuthenticatedRequest,
        @Param('chatId') chatId: string,
        @Body() body: { documentId: string; documentName: string }
    ) {
        return this.chatService.addDocument(
            chatId,
            req.user,
            body.documentId,
            body.documentName
        );
    }

    @Delete(':chatId/documents/:documentId')
    @ApiOperation({ summary: 'Xóa document khỏi chat' })
    async removeDocument(
        @Req() req: AuthenticatedRequest,
        @Param('chatId') chatId: string,
        @Param('documentId') documentId: string
    ) {
        return this.chatService.removeDocument(chatId, req.user, documentId);
    }
}
