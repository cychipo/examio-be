model AIChat {
    id        String   @id
    userId    String
    subjectId String? // Giáo viên AI (môn học) - nullable để backward compatible
    title     String   @default("")
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
    subject   Subject?         @relation(fields: [subjectId], references: [id], onDelete: SetNull)
    messages  AIChatMessage[]
    documents AIChatDocument[] // Multi-file support

    @@index([userId, updatedAt(sort: Desc)])
    @@index([subjectId])
}

model AIChatMessage {
    id           String   @id
    chatId       String
    role         String // "user" | "assistant"
    content      String
    imageUrl     String? // URL ảnh nếu có upload
    documentId   String? // ID của UserStorage nếu dùng PDF context
    documentName String? // Tên file để hiển thị
    createdAt    DateTime @default(now())

    chat AIChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

    @@index([chatId, createdAt])
}

// Junction table for multi-document support
// Allows O(1) lookup of all documents for a chat via chatId index
model AIChatDocument {
    id           String   @id @default(cuid())
    chatId       String
    documentId   String // UserStorage ID (file gốc)
    documentName String // File name for display
    createdAt    DateTime @default(now())

    chat        AIChat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
    userStorage UserStorage @relation(fields: [documentId], references: [id], onDelete: Cascade)

    // Composite unique constraint prevents duplicate document per chat
    @@unique([chatId, documentId])
    // Index for O(1) lookup of documents by chatId
    @@index([chatId])
}
