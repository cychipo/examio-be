name: Deploy Microservices

on:
  push:
    branches: [main, dev, staging]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
      force_rebuild:
        description: 'Force rebuild without cache'
        type: boolean
        default: false

env:
  COMPOSE_PROJECT_NAME: examio-be
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Get branch name
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "name=${{ github.event.inputs.branch }}" >> $GITHUB_OUTPUT
            echo "force_rebuild=${{ github.event.inputs.force_rebuild }}" >> $GITHUB_OUTPUT
          else
            echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
            echo "force_rebuild=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          command_timeout: 20000m
          script: |
            set -e

            BRANCH="${{ steps.branch.outputs.name }}"
            FORCE_REBUILD="${{ steps.branch.outputs.force_rebuild }}"
            DEPLOY_DIR="${{ secrets.SERVER_DEPLOY_DIR }}"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ EXAMIO BACKEND DEPLOYMENT"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ Branch: $BRANCH"
            echo "๐ Directory: $DEPLOY_DIR"
            echo "โฐ Timestamp: $TIMESTAMP"
            echo "๐ Force Rebuild: $FORCE_REBUILD"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

            # ================================================================
            # PHASE 1: PREPARE
            # ================================================================
            echo ""
            echo "๐ฆ PHASE 1: PREPARE"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"

            # Get current commit for comparison
            OLD_COMMIT=""
            if [ -d .git ]; then
              OLD_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "")
            fi

            # Pull latest code
            echo "๐ฅ Pulling latest code..."
            if [ -d .git ]; then
              git fetch origin "$BRANCH" --prune
              git reset --hard "origin/$BRANCH"
              git clean -fd
            else
              git clone -b "$BRANCH" "https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git" .
            fi

            NEW_COMMIT=$(git rev-parse HEAD)
            echo "๐ Commit: $NEW_COMMIT"

            # Check if code changed
            if [ "$OLD_COMMIT" = "$NEW_COMMIT" ] && [ "$FORCE_REBUILD" != "true" ]; then
              echo "โ No code changes detected. Skipping build."
              echo "๐ก Use 'Force rebuild' option to rebuild anyway."
              exit 0
            fi

            # Setup docker-compose and Dockerfile
            echo "๐ Configuring build files..."
            cp deploy/docker-compose.yml docker-compose.yml
            cp deploy/Dockerfile Dockerfile

            # Verify .env exists
            if [ ! -f .env ]; then
              echo "โ ERROR: .env file not found!"
              echo "Please create .env file on the server first."
              exit 1
            fi

            # ================================================================
            # PHASE 2: BUILD (Services still running - zero downtime)
            # ================================================================
            echo ""
            echo "๐จ PHASE 2: BUILD"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ก Building new images while services are still running..."

            BUILD_ARGS=""
            if [ "$FORCE_REBUILD" = "true" ]; then
              BUILD_ARGS="--no-cache"
              echo "โ๏ธ  Force rebuild: cache disabled"
            fi

            # Build all services in parallel with BuildKit cache
            # Old containers keep running during build
            docker compose build $BUILD_ARGS --parallel 2>&1 | while read line; do
              echo "   $line"
            done

            BUILD_STATUS=$?
            if [ $BUILD_STATUS -ne 0 ]; then
              echo "โ Build failed!"
              exit 1
            fi

            echo "โ All images built successfully"

            # ================================================================
            # PHASE 3: ROLLING UPDATE (Minimal downtime)
            # ================================================================
            echo ""
            echo "๐ PHASE 3: ROLLING UPDATE"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

            # Check if services are running
            RUNNING_SERVICES=$(docker compose ps -q 2>/dev/null | wc -l || echo "0")

            if [ "$RUNNING_SERVICES" -gt 0 ]; then
              echo "๐ Current running services: $RUNNING_SERVICES"
              echo "๐ Performing rolling update..."

              # Rolling update: recreate containers one by one with new images
              # --no-deps prevents restarting dependencies
              # This minimizes downtime

              # Infrastructure services first (no deps)
              echo "   โ Updating infrastructure..."
              docker rm -f examio-rabbitmq 2>/dev/null || true
              docker compose up -d --no-deps --force-recreate rabbitmq 2>/dev/null || true

              # Independent services
              echo "   โ Updating r2, finance..."
              docker rm -f examio-r2 examio-finance 2>/dev/null || true
              docker compose up -d --no-deps --force-recreate r2 finance

              # Wait for them to be healthy
              echo "   โ Waiting for base services..."
              sleep 10

              # Services with dependencies
              echo "   โ Updating auth..."
              docker rm -f examio-auth 2>/dev/null || true
              docker compose up -d --no-deps --force-recreate auth
              sleep 5

              echo "   โ Updating ai, exam..."
              docker rm -f examio-ai examio-exam 2>/dev/null || true
              docker compose up -d --no-deps --force-recreate ai exam
              sleep 5

              # Gateway last (depends on all)
              echo "   โ Updating gateway..."
              docker rm -f examio-gateway 2>/dev/null || true
              docker compose up -d --no-deps --force-recreate gateway

            else
              echo "๐ No running services. Starting fresh..."
              docker compose up -d --remove-orphans
            fi

            echo "โ Services updated"

            # ================================================================
            # PHASE 4: HEALTH CHECK
            # ================================================================
            echo ""
            echo "๐ฅ PHASE 4: HEALTH CHECK"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

            # Wait for services to initialize
            echo "โณ Waiting for services to initialize (30s)..."
            sleep 30

            # Health check with retries
            MAX_RETRIES=5
            RETRY_DELAY=10
            HEALTHY=false

            for i in $(seq 1 $MAX_RETRIES); do
              echo "   Attempt $i/$MAX_RETRIES..."

              if docker compose exec -T gateway wget -q --spider http://localhost:7000/api/v1/health 2>/dev/null; then
                HEALTHY=true
                break
              fi

              if [ $i -lt $MAX_RETRIES ]; then
                echo "   โณ Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
              fi
            done

            if [ "$HEALTHY" = "true" ]; then
              echo "โ Gateway is healthy!"
            else
              echo "โ Gateway health check failed after $MAX_RETRIES attempts!"
              echo ""
              echo "๐ Gateway logs:"
              docker compose logs gateway --tail=100
              echo ""
              echo "๐ All services status:"
              docker compose ps
              exit 1
            fi

            # Check all services
            echo ""
            echo "๐ Service Status:"
            docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Health}}"

            # ================================================================
            # PHASE 5: CLEANUP (Background, non-blocking)
            # ================================================================
            echo ""
            echo "๐งน PHASE 5: CLEANUP"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

            # Remove old unused images (only dangling, safe)
            echo "   โ Removing dangling images..."
            docker image prune -f --filter "until=1h" 2>/dev/null || true

            # Clean old build cache (older than 7 days)
            echo "   โ Cleaning old build cache..."
            docker builder prune -f --filter "until=168h" 2>/dev/null || true

            # Remove stopped containers
            echo "   โ Removing stopped containers..."
            docker container prune -f --filter "until=1h" 2>/dev/null || true

            echo "โ Cleanup completed"

            # ================================================================
            # DONE
            # ================================================================
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ DEPLOYMENT COMPLETED SUCCESSFULLY!"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ Branch: $BRANCH"
            echo "๐ Commit: $NEW_COMMIT"
            echo "โฐ Completed: $(date)"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "โ Deployment successful"
          else
            echo "โ Deployment failed"
            exit 1
          fi
