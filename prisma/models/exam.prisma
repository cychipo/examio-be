model QuizSet {
  id          String   @id @default(cuid())
  title       String
  description String?
  userId      String
  thumbnail   String?
  isPublic    Boolean  @default(false)
  isPinned    Boolean  @default(false)
  tags        String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  createdBy   String?
  updatedBy   String?

  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  detailsQuizQuestions DetailsQuizQuestion[]
  examRooms            ExamRoom[]
}

model FlashCardSet {
  id          String   @id @default(cuid())
  title       String
  userId      String
  thumbnail   String?
  description String?
  tag         String[] @default([])
  isPublic    Boolean  @default(false)
  isPinned    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedBy   String?
  createdBy   String?
  updatedAt   DateTime @default(now()) @updatedAt

  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  detailsFlashCard DetailsFlashCard[]
}

model QuizQuestion {
  id        String   @id @default(cuid())
  question  String
  options   String[]
  answer    String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  detailsQuizQuestions DetailsQuizQuestion[]
}

model DetailsQuizQuestion {
  id                      String  @id @default(cuid())
  quizSetId               String
  quizQuestionId          String
  historyGeneratedQuizzId String?

  quizSet               QuizSet                @relation(fields: [quizSetId], references: [id], onDelete: Cascade)
  quizQuestion          QuizQuestion           @relation(fields: [quizQuestionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  historyGeneratedQuizz HistoryGeneratedQuizz? @relation(fields: [historyGeneratedQuizzId], references: [id], onDelete: SetNull)

  @@unique([quizSetId, quizQuestionId])
  @@index([quizSetId])
  @@index([quizQuestionId])
  @@index([historyGeneratedQuizzId])
}

model FlashCard {
  id        String   @id @default(cuid())
  question  String
  answer    String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  detailsFlashCards DetailsFlashCard[]
}

model DetailsFlashCard {
  id                          String  @id @default(cuid())
  flashCardSetId              String
  flashCardId                 String
  historyGeneratedFlashcardId String?

  flashCardSet              FlashCardSet               @relation(fields: [flashCardSetId], references: [id], onDelete: Cascade)
  flashCard                 FlashCard                  @relation(fields: [flashCardId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  historyGeneratedFlashcard HistoryGeneratedFlashcard? @relation(fields: [historyGeneratedFlashcardId], references: [id], onDelete: SetNull)

  @@unique([flashCardSetId, flashCardId])
  @@index([flashCardSetId])
  @@index([flashCardId])
  @@index([historyGeneratedFlashcardId])
}

model ExamRoom {
  id          String   @id @default(cuid())
  title       String
  description String?
  quizSetId   String
  hostId      String
  assessType  Int // 0: PUBLIC, 1: PRIVATE
  allowRetake Boolean  @default(false)
  maxAttempts Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  createdBy   String?
  updatedBy   String?

  host    User    @relation(fields: [hostId], references: [id], onDelete: Cascade)
  quizSet QuizSet @relation(fields: [quizSetId], references: [id], onDelete: Cascade)

  examSessions ExamSession[]
}

model ExamSession {
  id             String    @id @default(cuid())
  examRoomId     String
  status         Int       @default(0) // 0: UPCOMING, 1: ONGOING, 2: ENDED
  startTime      DateTime
  endTime        DateTime?
  autoJoinByLink Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt
  createdBy      String?
  updatedBy      String?

  examRoom     ExamRoom                 @relation(fields: [examRoomId], references: [id], onDelete: Cascade)
  participants ExamSessionParticipant[]
  examAttempts ExamAttempt[]
}

model ExamAttempt {
  id             String    @id @default(cuid())
  examSessionId  String
  userId         String
  score          Float
  violationCount Int       @default(0)
  startedAt      DateTime
  finishedAt     DateTime?
  status         Int       @default(0) // 0: IN_PROGRESS, 1: COMPLETED, 2: CANCELLED
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt
  createdBy      String?
  updatedBy      String?

  examSession ExamSession @relation(fields: [examSessionId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ExamSessionParticipant {
  id            String    @id @default(cuid())
  examSessionId String
  userId        String
  status        Int       @default(0) // 0: PENDING, 1: APPROVED, 2: REJECTED, 3: LEFT
  joinedAt      DateTime?
  leftAt        DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  createdBy     String?
  updatedBy     String?

  examSession ExamSession @relation(fields: [examSessionId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model HistoryGeneratedQuizz {
  id            String   @id @default(cuid())
  userId        String
  userStorageId String
  quizzes       Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userStorage          UserStorage           @relation(fields: [userStorageId], references: [id], onDelete: Cascade)
  detailsQuizQuestions DetailsQuizQuestion[]
}

model HistoryGeneratedFlashcard {
  id            String   @id @default(cuid())
  userId        String
  userStorageId String
  flashcards    Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  userStorage       UserStorage        @relation(fields: [userStorageId], references: [id], onDelete: Cascade)
  detailsFlashCards DetailsFlashCard[]
}
